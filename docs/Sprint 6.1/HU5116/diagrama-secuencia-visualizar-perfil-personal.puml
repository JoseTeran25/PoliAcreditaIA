@startuml diagrama-secuencia-visualizar-perfil-personal
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceParticipantBorderColor #2E5C8B
skinparam sequenceActorBorderColor #2E5C8B
skinparam sequenceActorBackgroundColor #E8F4FD
skinparam sequenceParticipantBackgroundColor #E8F4FD
skinparam sequenceMessageTextSize 11
skinparam sequenceActorFontSize 11
skinparam sequenceParticipantFontSize 11

title HU5116: Visualizar Perfil Personal del Usuario

actor "Usuario\nAutenticado" as user
participant "Frontend\n(Cliente)" as frontend
participant "Auth Guard\n(JWT)" as auth
participant "UsuariosController" as controller
participant "UsuariosService" as service
participant "UsuarioModel\n(Sequelize)" as model
database "PostgreSQL\nDatabase" as db

== Caso Exitoso: Obtener Perfil Personal ==

user -> frontend: GET /me/profile
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth -> auth: Validar token y extraer userId
auth -> auth: Verificar usuario activo y token vÃ¡lido
auth --> frontend: âœ… Token vÃ¡lido, usuario autenticado\n(user.id = 5)
deactivate auth

frontend -> controller: GET /me/profile + user context
activate controller

controller -> service: getProfile(user.id = 5)
activate service

service -> model: findByPk(5, {include: facultad})
activate model
model -> db: SELECT u.*, f.id as "facultad.id",\nf.nombre as "facultad.nombre",\nf.codigo as "facultad.codigo"\nFROM usuarios u\nLEFT JOIN facultades f ON u.facultadId = f.id\nWHERE u.id = 5
activate db
db --> model: Usuario encontrado con facultad
deactivate db
model --> service: UsuarioModel instance con relaciones
deactivate model

service -> service: Verificar usuario activo
service -> service: âœ… usuario.estadoActivo = true

service -> service: Construir UserProfileDto (sin contraseÃ±a)
service -> service: Mapear datos seguros:\n- id, nombres, apellidos\n- cedula, correo, rol\n- estadoActivo, facultad\n- createdAt, updatedAt

service --> controller: UserProfileDto\n{\n  id: 5,\n  nombres: "Carlos Eduardo",\n  apellidos: "RodrÃ­guez Silva",\n  cedula: "1234567890",\n  correo: "carlos.rodriguez@epn.edu.ec",\n  rol: "PROFESOR",\n  estadoActivo: true,\n  facultad: {\n    id: 1,\n    nombre: "Facultad de IngenierÃ­a de Sistemas",\n    codigo: "FIS"\n  },\n  createdAt: "2024-01-15T10:30:00.000Z",\n  updatedAt: "2024-01-20T15:45:00.000Z"\n}
deactivate service

controller --> frontend: 200 OK + UserProfileDto
deactivate controller

frontend --> user: âœ… Perfil personal obtenido\nğŸ“‹ InformaciÃ³n completa y actualizada
deactivate frontend

== Caso Exitoso: Perfil de Administrador (Sin Facultad) ==

user -> frontend: GET /me/profile\n(Usuario administrador)
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido (user.id = 1, rol = ADMINISTRADOR)
deactivate auth

frontend -> controller: GET /me/profile
activate controller

controller -> service: getProfile(1)
activate service

service -> model: findByPk(1, {include: facultad})
activate model
model -> db: SELECT u.*, f.* FROM usuarios u\nLEFT JOIN facultades f ON u.facultadId = f.id\nWHERE u.id = 1
activate db
db --> model: Usuario administrador (sin facultad asociada)
deactivate db
model --> service: UsuarioModel (facultad = null)
deactivate model

service -> service: Verificar usuario activo âœ…
service -> service: Construir perfil con facultad = undefined

service --> controller: UserProfileDto sin facultad\n{\n  id: 1,\n  nombres: "MarÃ­a Elena",\n  apellidos: "GarcÃ­a LÃ³pez",\n  ...\n  rol: "ADMINISTRADOR",\n  facultad: undefined\n}
deactivate service

controller --> frontend: 200 OK
deactivate controller

frontend --> user: âœ… Perfil de administrador obtenido
deactivate frontend

== Caso de Error: Token JWT InvÃ¡lido ==

user -> frontend: GET /me/profile\n(Token invÃ¡lido o expirado)
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth -> auth: Validar token
auth -> auth: âŒ Token invÃ¡lido/expirado
auth --> frontend: UnauthorizedException
deactivate auth

frontend --> user: 401 Unauthorized\n{\n  "statusCode": 401,\n  "message": "Unauthorized",\n  "error": "Unauthorized"\n}
deactivate frontend

== Caso de Error: Usuario No Encontrado ==

user -> frontend: GET /me/profile\n(Token vÃ¡lido pero usuario eliminado)
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido (user.id = 999)
deactivate auth

frontend -> controller: GET /me/profile
activate controller

controller -> service: getProfile(999)
activate service

service -> model: findByPk(999, {include: facultad})
activate model
model -> db: SELECT * FROM usuarios WHERE id = 999
activate db
db --> model: null (usuario no existe)
deactivate db
model --> service: null
deactivate model

service -> service: throw NotFoundException
service --> controller: âŒ Usuario con ID 999 no encontrado
deactivate service

controller --> frontend: 404 Not Found\n{\n  "statusCode": 404,\n  "message": "Usuario con ID 999 no encontrado",\n  "error": "Not Found"\n}
deactivate controller

frontend --> user: âŒ Error: Usuario no encontrado
deactivate frontend

== Caso de Error: Usuario Inactivo ==

user -> frontend: GET /me/profile\n(Token vÃ¡lido, usuario inactivo)
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth -> auth: Durante validaciÃ³n JWT Strategy
auth -> auth: âŒ usuario.estadoActivo = false
auth --> frontend: UnauthorizedException\n"Token no vÃ¡lido o usuario inactivo"
deactivate auth

frontend --> user: 401 Unauthorized\n{\n  "statusCode": 401,\n  "message": "Token no vÃ¡lido o usuario inactivo",\n  "error": "Unauthorized"\n}
deactivate frontend

note right of auth
  **Nota importante**: El JWT Strategy 
  ya valida que el usuario estÃ© activo,
  por lo que usuarios inactivos no 
  pueden pasar la autenticaciÃ³n.
  
  Esto proporciona una capa adicional
  de seguridad automÃ¡tica.
end note

== Caso de Uso: Verificar Cambios Recientes ==

user -> frontend: GET /me/profile\n(DespuÃ©s de actualizar datos)
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> controller: GET /me/profile
activate controller

controller -> service: getProfile(user.id)
activate service

service -> model: findByPk con relaciones
activate model
model -> db: SELECT con datos actualizados
activate db
db --> model: Datos con updatedAt reciente
deactivate db
model --> service: Usuario con cambios
deactivate model

service --> controller: Perfil con updatedAt actualizado
deactivate service

controller --> frontend: 200 OK con datos frescos
deactivate controller

frontend --> user: âœ… Perfil actualizado mostrado\nğŸ• updatedAt: "2024-01-25T10:15:00.000Z"
deactivate frontend

note over user, db
  **CaracterÃ­sticas de Seguridad de la HU5116:**
  
  ğŸ” **Privacidad absoluta**: Solo el usuario autenticado puede ver su perfil
  ğŸ›¡ï¸ **Sin datos sensibles**: ContraseÃ±a y datos confidenciales excluidos
  âœ… **VerificaciÃ³n automÃ¡tica**: JWT Strategy valida usuario activo
  ğŸš« **Sin acceso cruzado**: Imposible ver perfiles de otros usuarios
  ğŸ”„ **Datos actualizados**: Siempre obtiene informaciÃ³n fresca de BD
  
  **InformaciÃ³n incluida en el perfil:**
  â€¢ Datos personales bÃ¡sicos (nombres, apellidos, cÃ©dula, correo)
  â€¢ Rol y estado de la cuenta
  â€¢ Facultad asociada (si corresponde)
  â€¢ Fechas de auditorÃ­a (creaciÃ³n y Ãºltima actualizaciÃ³n)
  
  **Casos de uso principales:**
  â€¢ Revisar informaciÃ³n personal antes de cambios
  â€¢ Verificar rol y permisos asignados
  â€¢ Consultar facultad de pertenencia
  â€¢ Validar estado de la cuenta
  â€¢ AuditorÃ­a personal de datos
end note

@enduml