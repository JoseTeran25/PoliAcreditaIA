@startuml diagrama-secuencia-busqueda-paginada-usuarios
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceParticipantBorderColor #2E5C8B
skinparam sequenceActorBorderColor #2E5C8B
skinparam sequenceActorBackgroundColor #E8F4FD
skinparam sequenceParticipantBackgroundColor #E8F4FD
skinparam sequenceMessageTextSize 11
skinparam sequenceActorFontSize 11
skinparam sequenceParticipantFontSize 11

title HU5099 & HU5107: BÃºsqueda y PaginaciÃ³n de Usuarios

actor "Administrador" as admin
participant "Frontend\n(Cliente)" as frontend
participant "Auth Guard\n(JWT)" as auth
participant "Roles Guard\n(RBAC)" as roles
participant "UsuariosController" as controller
participant "ValidationPipe" as validator
participant "UsuariosService" as service
participant "UsuarioModel\n(Sequelize)" as model
database "PostgreSQL\nDatabase" as db

== Caso Exitoso: BÃºsqueda con PaginaciÃ³n ==

admin -> frontend: GET /usuarios/paginated?\nsearch=juan&page=1&limit=10
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth -> auth: Validar token y usuario activo
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> roles: Verificar permisos
activate roles
roles -> roles: Validar rol ADMINISTRADOR
roles --> frontend: Permisos vÃ¡lidos
deactivate roles

frontend -> controller: GET /usuarios/paginated
activate controller

controller -> validator: Validar SearchPaginatedUsuarioDto
activate validator
validator -> validator: @IsOptional() search\n@Type() page, limit\n@Min(1) page\n@Max(50) limit
validator --> controller: âœ… ParÃ¡metros vÃ¡lidos
deactivate validator

controller -> service: findAllPaginated(searchDto)
activate service

service -> service: Construir whereClause para bÃºsqueda
service -> service: search="juan" â†’ OR conditions:\n- correo ILIKE '%juan%'\n- nombres ILIKE '%juan%'\n- apellidos ILIKE '%juan%'\n- cedula ILIKE '%juan%'

service -> service: Calcular offset: (page-1) * limit = 0

service -> model: findAndCountAll(whereClause, limit, offset)
activate model
model -> db: SELECT COUNT(*) FROM usuarios\nWHERE (correo ILIKE '%juan%' OR nombres ILIKE '%juan%'\nOR apellidos ILIKE '%juan%' OR cedula ILIKE '%juan%')
activate db
db --> model: count = 15
deactivate db

model -> db: SELECT u.*, f.id, f.nombre, f.codigo\nFROM usuarios u\nLEFT JOIN facultades f ON u.facultadId = f.id\nWHERE (correo ILIKE '%juan%' OR nombres ILIKE '%juan%'\nOR apellidos ILIKE '%juan%' OR cedula ILIKE '%juan%')\nORDER BY u.apellidos ASC, u.nombres ASC\nLIMIT 10 OFFSET 0
activate db
db --> model: 10 usuarios encontrados
deactivate db
model --> service: {count: 15, rows: [usuarios]}
deactivate model

service -> service: Calcular metadatos:\n- totalPages = ceil(15/10) = 2\n- hasNextPage = 1 < 2 = true\n- hasPreviousPage = 1 > 1 = false

service --> controller: UsuarioPaginatedResponseDto\n{\n  data: [10 usuarios],\n  meta: {\n    currentPage: 1,\n    pageSize: 10,\n    totalItems: 15,\n    totalPages: 2,\n    hasNextPage: true,\n    hasPreviousPage: false,\n    searchTerm: "juan"\n  }\n}
deactivate service

controller --> frontend: 200 OK + respuesta paginada
deactivate controller

frontend --> admin: âœ… 10 usuarios encontrados (pÃ¡gina 1 de 2)
deactivate frontend

== Caso Exitoso: Listado Completo Paginado (Sin BÃºsqueda) ==

admin -> frontend: GET /usuarios/paginated?\npage=2&limit=5
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> roles: Verificar permisos
activate roles
roles --> frontend: Permisos vÃ¡lidos
deactivate roles

frontend -> controller: GET /usuarios/paginated
activate controller

controller -> validator: Validar parÃ¡metros
activate validator
validator --> controller: ParÃ¡metros vÃ¡lidos
deactivate validator

controller -> service: findAllPaginated({page: 2, limit: 5})
activate service

service -> service: No hay search â†’ whereClause = {} (todos los usuarios)
service -> service: offset = (2-1) * 5 = 5

service -> model: findAndCountAll({}, limit=5, offset=5)
activate model
model -> db: SELECT COUNT(*) FROM usuarios
activate db
db --> model: count = 23
deactivate db

model -> db: SELECT u.*, f.id, f.nombre, f.codigo\nFROM usuarios u\nLEFT JOIN facultades f ON u.facultadId = f.id\nORDER BY u.apellidos ASC, u.nombres ASC\nLIMIT 5 OFFSET 5
activate db
db --> model: 5 usuarios (registros 6-10)
deactivate db
model --> service: {count: 23, rows: [5 usuarios]}
deactivate model

service -> service: Calcular metadatos:\n- totalPages = ceil(23/5) = 5\n- hasNextPage = 2 < 5 = true\n- hasPreviousPage = 2 > 1 = true

service --> controller: Respuesta paginada completa
deactivate service

controller --> frontend: 200 OK
deactivate controller

frontend --> admin: âœ… 5 usuarios (pÃ¡gina 2 de 5)
deactivate frontend

== Caso Sin Resultados: BÃºsqueda Sin Coincidencias ==

admin -> frontend: GET /usuarios/paginated?\nsearch=usuarionoexiste&page=1&limit=10
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> roles: Verificar permisos
activate roles
roles --> frontend: Permisos vÃ¡lidos
deactivate roles

frontend -> controller: GET /usuarios/paginated
activate controller

controller -> validator: Validar parÃ¡metros
activate validator
validator --> controller: ParÃ¡metros vÃ¡lidos
deactivate validator

controller -> service: findAllPaginated(searchDto)
activate service

service -> service: search="usuarionoexiste" â†’ whereClause con OR

service -> model: findAndCountAll(whereClause, limit, offset)
activate model
model -> db: SELECT COUNT(*) FROM usuarios\nWHERE (correo ILIKE '%usuarionoexiste%' OR ...)
activate db
db --> model: count = 0
deactivate db

model -> db: SELECT ... LIMIT 10 OFFSET 0
activate db
db --> model: [] (sin resultados)
deactivate db
model --> service: {count: 0, rows: []}
deactivate model

service -> service: Calcular metadatos:\n- totalPages = ceil(0/10) = 0\n- hasNextPage = false\n- hasPreviousPage = false

service --> controller: {\n  data: [],\n  meta: {\n    currentPage: 1,\n    pageSize: 10,\n    totalItems: 0,\n    totalPages: 0,\n    hasNextPage: false,\n    hasPreviousPage: false,\n    searchTerm: "usuarionoexiste"\n  }\n}
deactivate service

controller --> frontend: 200 OK (lista vacÃ­a)
deactivate controller

frontend --> admin: âœ… Sin resultados encontrados
deactivate frontend

== Caso de Error: ParÃ¡metros de PaginaciÃ³n InvÃ¡lidos ==

admin -> frontend: GET /usuarios/paginated?\npage=0&limit=100
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> roles: Verificar permisos
activate roles
roles --> frontend: Permisos vÃ¡lidos
deactivate roles

frontend -> controller: GET /usuarios/paginated
activate controller

controller -> validator: Validar SearchPaginatedUsuarioDto
activate validator
validator -> validator: @Min(1) page â†’ âŒ page=0 invÃ¡lido
validator -> validator: @Max(50) limit â†’ âŒ limit=100 invÃ¡lido
validator --> controller: ValidationError
deactivate validator

controller --> frontend: 400 Bad Request\n{\n  "statusCode": 400,\n  "message": [\n    "La pÃ¡gina debe ser mayor a 0",\n    "El lÃ­mite no puede ser mayor a 50"\n  ],\n  "error": "Bad Request"\n}
deactivate controller

frontend --> admin: âŒ Error: ParÃ¡metros invÃ¡lidos
deactivate frontend

== Caso de Error: Sin Permisos ==

admin -> frontend: GET /usuarios/paginated?\nsearch=juan&page=1&limit=10\n(Usuario sin rol ADMINISTRADOR)
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> roles: Verificar permisos
activate roles
roles -> roles: Usuario no tiene rol ADMINISTRADOR
roles --> frontend: âŒ Acceso denegado
deactivate roles

frontend --> admin: 403 Forbidden\n{\n  "statusCode": 403,\n  "message": "Forbidden resource",\n  "error": "Forbidden"\n}
deactivate frontend

== Caso BÃºsqueda por CÃ©dula EspecÃ­fica ==

admin -> frontend: GET /usuarios/paginated?\nsearch=1234567890&page=1&limit=10
activate frontend

frontend -> auth: Verificar token JWT
activate auth
auth --> frontend: Token vÃ¡lido
deactivate auth

frontend -> roles: Verificar permisos
activate roles
roles --> frontend: Permisos vÃ¡lidos
deactivate roles

frontend -> controller: GET /usuarios/paginated
activate controller

controller -> service: findAllPaginated(searchDto)
activate service

service -> service: search="1234567890" â†’ buscar en cÃ©dula principalmente

service -> model: findAndCountAll con OR condition
activate model
model -> db: SELECT COUNT(*) FROM usuarios\nWHERE (correo ILIKE '%1234567890%' OR nombres ILIKE '%1234567890%'\nOR apellidos ILIKE '%1234567890%' OR cedula ILIKE '%1234567890%')
activate db
db --> model: count = 1 (coincidencia exacta en cÃ©dula)
deactivate db

model --> service: 1 usuario encontrado
deactivate model
service --> controller: Usuario especÃ­fico encontrado
deactivate service

controller --> frontend: 200 OK con 1 resultado
deactivate controller

frontend --> admin: âœ… Usuario encontrado por cÃ©dula
deactivate frontend

note over admin, db
  **CaracterÃ­sticas Implementadas:**
  
  **HU5099 - BÃºsqueda por Palabra Clave:**
  ğŸ” **Campos de bÃºsqueda**: correo, nombres, apellidos, cÃ©dula
  ğŸ¯ **BÃºsqueda inteligente**: Una palabra busca en todos los campos
  ğŸ“ **Tolerante**: Ignora espacios y no distingue mayÃºsculas/minÃºsculas
  âœ… **Sin errores**: Lista vacÃ­a cuando no hay coincidencias
  
  **HU5107 - PaginaciÃ³n:**
  ğŸ“„ **Control flexible**: PÃ¡gina y tamaÃ±o configurables
  ğŸ“Š **LÃ­mites seguros**: MÃ¡ximo 50 elementos por pÃ¡gina
  ğŸ“ˆ **Metadatos completos**: Total de elementos, pÃ¡ginas, navegaciÃ³n
  ğŸ”„ **NavegaciÃ³n intuitiva**: Indicadores de pÃ¡gina anterior/siguiente
  
  **Funcionalidades adicionales:**
  ğŸ”— **Relaciones**: Incluye datos de facultad asociada
  ğŸ“‹ **Ordenamiento**: Por apellidos y nombres alfabÃ©ticamente
  ğŸ›¡ï¸ **Seguridad**: Solo administradores pueden acceder
  ğŸ¨ **DocumentaciÃ³n**: Swagger con ejemplos detallados
end note

@enduml